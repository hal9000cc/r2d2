# План тестов для buy_sltp/sell_sltp

## 1. СПИСОК ВАРИАНТОВ ТЕСТОВ

### Группа A: Базовые варианты постановки ордеров

#### A1. Простые варианты входа
- **A1.1**: Вход по рынку, один стоп, один тейк
- **A1.2**: Вход лимиткой (один ордер), один стоп, один тейк
- **A1.3**: Вход несколькими лимитками, один стоп, один тейк

#### A2. Множественные стопы/тейки
- **A2.1**: Вход по рынку, несколько стопов (равные доли), несколько тейков (равные доли)
- **A2.2**: Вход по рынку, несколько стопов (кастомные доли), несколько тейков (кастомные доли)
- **A2.3**: Вход лимиткой, несколько стопов, несколько тейков
- **A2.4**: Вход несколькими лимитками, несколько стопов, несколько тейков

#### A3. Варианты без стопов или тейков
- **A3.1**: Вход по рынку, только стопы (без тейков)
- **A3.2**: Вход по рынку, только тейки (без стопов)
- **A3.3**: Вход лимиткой, только стопы
- **A3.4**: Вход лимиткой, только тейки
- **A3.5**: Вход несколькими лимитками, только стопы
- **A3.6**: Вход несколькими лимитками, только тейки

---

### Группа B: Отработка ордеров - простые случаи

#### B1. Отработка одного ордера
- **B1.1**: Вход по рынку → стоп срабатывает (цена задевает только стоп)
- **B1.2**: Вход по рынку → тейк срабатывает (цена задевает только тейк)
- **B1.3**: Вход лимиткой → вход срабатывает → стоп срабатывает
- **B1.4**: Вход лимиткой → вход срабатывает → тейк срабатывает

#### B2. Отработка нескольких однотипных ордеров одной свечой
- **B2.1**: Вход по рынку → несколько стопов срабатывают одновременно (цена задевает все стопы)
- **B2.2**: Вход по рынку → несколько тейков срабатывают одновременно (цена задевает все тейки)
- **B2.3**: Несколько входных лимиток → все срабатывают одновременно
- **B2.4**: Вход по рынку → несколько стопов срабатывают последовательно (на разных барах)
- **B2.5**: Вход по рынку → несколько тейков срабатывают последовательно (на разных барах)

#### B3. Частичная отработка однотипных ордеров
- **B3.1**: Вход по рынку → несколько стопов, срабатывает только один (цена задевает один стоп)
- **B3.2**: Вход по рынку → несколько стопов, срабатывает часть (цена задевает часть стопов)
- **B3.3**: Вход по рынку → несколько тейков, срабатывает только один
- **B3.4**: Вход по рынку → несколько тейков, срабатывает часть
- **B3.5**: Несколько входных лимиток → срабатывает только одна
- **B3.6**: Несколько входных лимиток → срабатывает часть

---

### Группа C: Отработка ордеров - сложные случаи (входы + стопы одновременно)

#### C1. Один вход, один стоп
- **C1.1**: Вход лимиткой и стоп задеваются одновременно → оба срабатывают
- **C1.2**: Вход по рынку → на следующем баре вход и стоп задеваются одновременно

#### C2. Один вход, несколько стопов
- **C2.1**: Вход лимиткой и все стопы задеваются одновременно → вход + все стопы срабатывают
- **C2.2**: Вход лимиткой и часть стопов задеваются одновременно → вход + часть стопов срабатывают
- **C2.3**: Вход по рынку → на следующем баре вход (уже выполнен) и все стопы задеваются одновременно

#### C3. Несколько входов, все стопы
- **C3.1**: Несколько входных лимиток и все стопы задеваются одновременно → все входы + все стопы срабатывают
- **C3.2**: Несколько входных лимиток и все стопы задеваются одновременно → часть входов + все стопы срабатывают

#### C4. Несколько входов, часть стопов
- **C4.1**: Несколько входных лимиток и часть стопов задеваются одновременно → все входы + часть стопов
- **C4.2**: Несколько входных лимиток и часть стопов задеваются одновременно → часть входов + часть стопов

---

### Группа D: Отработка ордеров - сложные случаи (входы + тейки одновременно)

#### D1. Один вход, один тейк
- **D1.1**: Вход лимиткой и тейк задеваются одновременно → оба срабатывают

#### D2. Один вход, несколько тейков
- **D2.1**: Вход лимиткой и все тейки задеваются одновременно → вход + все тейки срабатывают
- **D2.2**: Вход лимиткой и часть тейков задеваются одновременно → вход + часть тейков срабатывают

#### D3. Несколько входов, все тейки
- **D3.1**: Несколько входных лимиток и все тейки задеваются одновременно → все входы + все тейки

#### D4. Несколько входов, часть тейков
- **D4.1**: Несколько входных лимиток и часть тейков задеваются одновременно → все входы + часть тейков
- **D4.2**: Несколько входных лимиток и часть тейков задеваются одновременно → часть входов + часть тейков

---

### Группа E: Отработка ордеров - самые сложные случаи (входы + стопы + тейки одновременно)

**ВАЖНОЕ ПРАВИЛО**: Когда цена задевает и стопы, и тейки одновременно, считаются только стопы. Тейки могут сработать на следующих барах, если сделка закроется не вся.

#### E1. Один вход, один стоп, один тейк
- **E1.1**: Вход лимиткой, стоп и тейк задеваются одновременно → вход + стоп срабатывают, тейк НЕ срабатывает
- **E1.2**: Вход лимиткой, стоп и тейк задеваются одновременно → вход + стоп срабатывают, тейк срабатывает на следующем баре (если сделка не закрылась полностью)

#### E2. Один вход, несколько стопов, один тейк
- **E2.1**: Вход лимиткой, все стопы и тейк задеваются одновременно → вход + все стопы срабатывают, тейк НЕ срабатывает
- **E2.2**: Вход лимиткой, часть стопов и тейк задеваются одновременно → вход + часть стопов срабатывают, тейк НЕ срабатывает

#### E3. Один вход, один стоп, несколько тейков
- **E3.1**: Вход лимиткой, стоп и все тейки задеваются одновременно → вход + стоп срабатывают, все тейки НЕ срабатывают
- **E3.2**: Вход лимиткой, стоп и все тейки задеваются одновременно → вход + стоп срабатывают, часть тейков срабатывает на следующем баре (если сделка не закрылась полностью)

#### E4. Один вход, несколько стопов, несколько тейков
- **E4.1**: Вход лимиткой, все стопы и все тейки задеваются одновременно → вход + все стопы срабатывают, все тейки НЕ срабатывают
- **E4.2**: Вход лимиткой, все стопы и часть тейков задеваются одновременно → вход + все стопы срабатывают, часть тейков НЕ срабатывает
- **E4.3**: Вход лимиткой, часть стопов и все тейки задеваются одновременно → вход + часть стопов срабатывают, все тейки НЕ срабатывают
- **E4.4**: Вход лимиткой, часть стопов и часть тейков задеваются одновременно → вход + часть стопов срабатывают, часть тейков НЕ срабатывает

#### E5. Несколько входов, стопы, тейки
- **E5.1**: Несколько входных лимиток, все стопы и все тейки задеваются одновременно → все входы + все стопы срабатывают, все тейки НЕ срабатывают
- **E5.2**: Несколько входных лимиток, все стопы и часть тейков задеваются одновременно → все входы + все стопы срабатывают, часть тейков НЕ срабатывает
- **E5.3**: Несколько входных лимиток, часть стопов и все тейки задеваются одновременно → все входы + часть стопов срабатывают, все тейки НЕ срабатывают
- **E5.4**: Несколько входных лимиток, часть стопов и часть тейков задеваются одновременно → все входы + часть стопов срабатывают, часть тейков НЕ срабатывает

---

### Группа F: Валидация и ошибки

#### F1. Валидация цен
- **F1.1**: BUY stop loss выше текущей цены → ошибка валидации
- **F1.2**: BUY take profit ниже текущей цены → ошибка валидации
- **F1.3**: SELL stop loss ниже текущей цены → ошибка валидации
- **F1.4**: SELL take profit выше текущей цены → ошибка валидации
- **F1.5**: BUY limit entry выше текущей цены → ошибка валидации
- **F1.6**: SELL limit entry ниже текущей цены → ошибка валидации

#### F2. Валидация структуры
- **F2.1**: Сумма долей стопов != 1.0 → ошибка валидации
- **F2.2**: Сумма долей тейков != 1.0 → ошибка валидации
- **F2.3**: Сумма долей входных ордеров != 1.0 → ошибка валидации
- **F2.4**: Отрицательные доли → ошибка валидации
- **F2.5**: Доли > 1.0 → ошибка валидации

---

### Группа G: Граничные случаи

#### G1. Полное закрытие позиции
- **G1.1**: Вход по рынку → все стопы срабатывают → сделка полностью закрыта
- **G1.2**: Вход по рынку → все тейки срабатывают → сделка полностью закрыта
- **G1.3**: Вход по рынку → часть стопов срабатывает → оставшаяся часть закрывается последним стопом
- **G1.4**: Вход по рынку → часть тейков срабатывает → оставшаяся часть закрывается последним тейком

#### G2. Частичное закрытие позиции
- **G2.1**: Вход по рынку → один стоп из нескольких срабатывает → позиция частично закрыта, остальные стопы активны
- **G2.2**: Вход по рынку → один тейк из нескольких срабатывает → позиция частично закрыта, остальные тейки активны

#### G4. Незакрытые сделки в конце теста
- **G4.1**: Вход по рынку, только стопы → стопы не срабатывают → сделка остается открытой → автоматическое закрытие в конце тестирования
- **G4.2**: Вход по рынку, только тейки → тейки не срабатывают → сделка остается открытой → автоматическое закрытие в конце тестирования
- **G4.3**: Вход по рынку, стопы и тейки → часть стопов срабатывает, часть тейков не срабатывает → сделка частично закрыта → автоматическое закрытие остатка в конце тестирования

**ВАЖНО**: В тестах, где сделка может остаться открытой (например, тесты без тейков, где стопы не срабатывают), бэктестер автоматически закроет сделку в конце тестирования. Это важно учитывать при проверке результатов - нужно проверить, что автоматическое закрытие произошло корректно.

#### G3. Отмена ордеров
- **G3.1**: Вход по рынку → стопы/тейки установлены → вход выполнен → отмена стопов/тейков → проверка отмены
- **G3.2**: Вход лимиткой → вход не выполнен → отмена входного ордера → проверка отмены

---

## 2. СПИСОК ДАННЫХ ДЛЯ ПРОВЕРКИ

### 2.1. Проверка результата установки ордеров (OrderOperationResult)

#### Структура результата
- `orders`: список всех созданных ордеров (входные + выходные)
  - Проверить количество ордеров
  - Проверить типы ордеров (MARKET, LIMIT, STOP)
  - Проверить стороны ордеров (BUY, SELL)
  - Проверить параметры каждого ордера (quantity, price, trigger_price)
- `error_messages`: список сообщений об ошибках
  - Проверить отсутствие ошибок в успешных случаях
  - Проверить наличие и содержание ошибок в случаях валидации
- `active`: список ID активных ордеров
  - Проверить соответствие ожидаемым активным ордерам
- `executed`: список ID выполненных ордеров
  - Проверить отсутствие выполненных ордеров при установке (кроме market entry)
- `canceled`: список ID отмененных ордеров
  - Проверить отсутствие отмененных ордеров при установке
- `error`: список ID ордеров с ошибками
  - Проверить отсутствие ошибок в успешных случаях
- `deal_id`: ID сделки
  - Проверить, что deal_id > 0
  - Проверить, что все ордера связаны с одной сделкой
- `volume`: объем позиции в сделке
  - Проверить, что volume = 0 при установке (до выполнения входных ордеров)

#### Детальная проверка ордеров
- **Входные ордера**:
  - Тип: MARKET или LIMIT
  - Сторона: BUY для buy_sltp, SELL для sell_sltp
  - Quantity: соответствует переданному объему
  - Price: для LIMIT - соответствует переданной цене, для MARKET - None
  - Trigger_price: None для входных ордеров
  - Status: ACTIVE (для LIMIT) или EXECUTED (для MARKET)
  - Deal_id: соответствует deal_id из результата

- **Выходные ордера (стопы)**:
  - Тип: STOP
  - Сторона: SELL для buy_sltp (закрытие BUY позиции), BUY для sell_sltp (закрытие SELL позиции)
  - Quantity: соответствует доле от входа (проверить после выполнения входа)
  - Price: None для STOP ордеров
  - Trigger_price: соответствует переданной цене стопа
  - Status: ACTIVE (стопы устанавливаются после выполнения входа)
  - Deal_id: соответствует deal_id из результата

- **Выходные ордера (тейки)**:
  - Тип: LIMIT
  - Сторона: SELL для buy_sltp, BUY для sell_sltp
  - Quantity: соответствует доле от входа (проверить после выполнения входа)
  - Price: соответствует переданной цене тейка
  - Trigger_price: None для LIMIT ордеров
  - Status: ACTIVE (тейки устанавливаются после выполнения входа)
  - Deal_id: соответствует deal_id из результата

---

### 2.2. Проверка отработки ордеров

#### Временные метки
- Проверить время выполнения каждого ордера (должно соответствовать бару, на котором он сработал)
- Проверить порядок выполнения ордеров (входные должны выполниться раньше выходных)

#### Цены выполнения
- **Market ордера**: 
  - Для BUY: цена выполнения = текущая цена + slippage
  - Для SELL: цена выполнения = текущая цена - slippage
- **Limit ордера**: цена выполнения = цена ордера (если цена задела ордер)
- **Stop ордера**: 
  - Выполняются как market ордера при срабатывании trigger_price
  - Для BUY stop (SELL side): цена выполнения = trigger_price - slippage
  - Для SELL stop (BUY side): цена выполнения = trigger_price + slippage
- Проверить, что цены соответствуют ожидаемым с учетом slippage

#### Объемы выполнения
- Проверить, что объемы выполнения соответствуют объемам ордеров
- Проверить частичные выполнения (если применимо)
- Проверить, что сумма объемов всех выходных ордеров не превышает объем входа

#### Статусы ордеров
- После выполнения: статус = EXECUTED
- Не выполненные: статус = ACTIVE или CANCELED
- Проверить переходы статусов

---

### 2.3. Проверка сделок (Trades)

#### Структура сделки
- `side`: BUY или SELL
- `price`: цена выполнения
- `quantity`: объем
- `sum`: сумма сделки (price * quantity)
- `fee`: комиссия
- `order_id`: ID ордера, который создал сделку
- `deal_id`: ID сделки (deal)

#### Проверка сделок
- Количество сделок должно соответствовать количеству выполненных ордеров
- Для закрытой позиции: сумма объемов BUY сделок должна равняться сумме объемов SELL сделок (по модулю)
- Комиссии должны рассчитываться правильно:
  - `fee_taker` для market ордеров и stop ордеров (которые выполняются как market)
  - `fee_maker` для limit ордеров
- Цены должны учитывать slippage:
  - Для BUY market ордеров: цена_исполнения = цена_рынка + slippage
  - Для SELL market ордеров: цена_исполнения = цена_рынка - slippage
  - Для stop ордеров: применяется slippage как для market ордеров
- Каждая сделка должна быть связана с соответствующим ордером через `order_id`
- Каждая сделка должна быть связана с deal через `deal_id`

---

### 2.4. Проверка Deal (сделки-позиции)

#### Структура Deal
- `deal_id`: уникальный ID
- `type`: DealType.LONG или DealType.SHORT (тип сделки)
- `quantity`: текущий объем позиции (положительный для LONG, отрицательный для SHORT)
- `avg_buy_price`: средняя цена покупки
- `avg_sell_price`: средняя цена продажи
- `buy_quantity`: суммарный объем покупок
- `buy_cost`: суммарная стоимость покупок
- `sell_quantity`: суммарный объем продаж
- `sell_proceeds`: суммарная выручка от продаж
- `fee`: суммарные комиссии
- `profit`: прибыль/убыток (рассчитывается только для закрытых сделок)
- `orders`: список всех ордеров сделки
- `trades`: список всех сделок (trades) в рамках этой позиции

#### Проверка Deal
- **При открытии позиции**:
  - `quantity` = сумма объемов входных ордеров (положительное для LONG, отрицательное для SHORT)
  - `avg_buy_price` = средневзвешенная цена покупок (если есть BUY сделки)
  - `avg_sell_price` = средневзвешенная цена продаж (если есть SELL сделки)
  - `buy_quantity` = сумма объемов всех BUY сделок
  - `buy_cost` = сумма (price * quantity) всех BUY сделок
  - `sell_quantity` = сумма объемов всех SELL сделок
  - `sell_proceeds` = сумма (price * quantity) всех SELL сделок
  - `fee` = сумма комиссий всех сделок
  - `profit` = None (сделка еще не закрыта)
  - `is_closed` = False

- **При частичном закрытии**:
  - `quantity` изменяется на объем закрытых выходных ордеров (уменьшается по модулю)
  - `avg_sell_price` обновляется (средневзвешенная цена всех SELL сделок)
  - `sell_quantity` увеличивается на объем закрытых выходных ордеров
  - `sell_proceeds` увеличивается на сумму закрытых выходных сделок
  - `fee` увеличивается на комиссии выходных сделок
  - `profit` = None (сделка еще не закрыта полностью)
  - `is_closed` = False

- **При полном закрытии**:
  - `quantity` = 0.0
  - `is_closed` = True
  - `profit` = sell_proceeds - buy_cost - fee (рассчитывается автоматически)
  - **ВАЖНО**: Проверить, что `profit` соответствует ожидаемому расчету:
    - Для BUY позиции: profit = (цена_выхода * объем) - комиссии_выхода - (цена_входа * объем + комиссии_входа)
    - Для SELL позиции: profit = (цена_входа * объем - комиссии_входа) - (цена_выхода * объем + комиссии_выхода)
    - Учесть slippage для market ордеров и stop ордеров (которые выполняются как market)
    - Учесть fee_taker для market/stop ордеров и fee_maker для limit ордеров
  - Все выходные ордера должны быть выполнены или отменены

- **Связь ордеров**:
  - Все ордера (входные + выходные) должны иметь одинаковый `deal_id`
  - Проверить через `broker.get_deal_by_id(deal_id)`

---

### 2.5. Проверка общего результата стратегии

#### Equity
- `equity_symbol`: объем позиции в базовой валюте
  - После полного закрытия = 0.0
  - При открытой LONG позиции = положительное значение (сумма объемов входных ордеров - сумма объемов выходных ордеров)
  - При открытой SHORT позиции = отрицательное значение
- `equity_usd`: баланс в USD
  - Изменяется при каждой сделке
  - Для BUY: уменьшается на (price * quantity + fee)
  - Для SELL: увеличивается на (price * quantity - fee)

#### Статистика
- Количество сделок (trades)
- Количество открытых/закрытых deals
- Общая прибыль/убыток (сумма `profit` всех закрытых deals)
- Максимальная просадка (drawdown)
- Проверить, что статистика корректно учитывает все сделки и deals

---

### 2.6. Проверка специфических сценариев

#### Одновременное срабатывание нескольких ордеров
- Проверить порядок выполнения (входные → выходные)
- Проверить, что все задетые ордера сработали
- Проверить цены выполнения (должны быть одинаковыми для всех ордеров, сработавших на одном баре)

#### Приоритет стопов над тейками
- Когда цена задевает и стопы, и тейки одновременно:
  - Стопы должны сработать
  - Тейки НЕ должны сработать на этом баре
  - Тейки могут сработать на следующих барах, если позиция не закрыта полностью

#### Частичное закрытие позиции
- После частичного закрытия:
  - Оставшиеся стопы/тейки должны остаться активными
  - Объемы оставшихся стопов/тейков должны быть пересчитаны пропорционально оставшейся позиции
  - Проверить, что последний стоп/тейк закрывает всю оставшуюся позицию (независимо от доли)

#### Отмена ордеров
- После отмены:
  - Статус ордеров = CANCELED
  - Ордера не должны выполниться
  - Позиция не должна измениться

---

## 3. ПРИМЕРЫ ТЕСТОВЫХ ДАННЫХ (Quotes)

**Принцип**: Между барами, где должны быть срабатывания, можно (но не обязательно) вставлять бары, где срабатываний быть не должно. Это делает тесты более реалистичными и проверяет, что ордера не срабатывают преждевременно.

### Для простых случаев
- Бар 1: цена 100.0 (установка ордеров)
- Бар 2: цена 98.0 (без срабатываний)
- Бар 3: цена 95.0 (срабатывание стопа)
- Бар 4: цена 97.0 (без срабатываний)
- Бар 5: цена 105.0 (срабатывание тейка)

### Для одновременного срабатывания
- Бар 1: цена 100.0 (установка ордеров)
- Бар 2: цена 99.0 (без срабатываний)
- Бар 3: high=110.0, low=90.0 (задевает и стоп, и тейк одновременно)
- Бар 4: цена 100.0 (без срабатываний, проверка что тейки не сработали)

### Для последовательного срабатывания
- Бар 1: цена 100.0 (установка ордеров)
- Бар 2: цена 98.0 (без срабатываний)
- Бар 3: low=95.0 (срабатывает первый стоп)
- Бар 4: цена 94.0 (без срабатываний)
- Бар 5: low=93.0 (срабатывает второй стоп)

### Для частичного срабатывания
- Бар 1: цена 100.0 (установка ордеров)
- Бар 2: цена 98.0 (без срабатываний)
- Бар 3: low=94.0 (задевает только один стоп из двух, второй стоп на 92.0)
- Бар 4: цена 93.0 (без срабатываний, второй стоп еще не задет)
- Бар 5: low=91.0 (срабатывает второй стоп)

---

